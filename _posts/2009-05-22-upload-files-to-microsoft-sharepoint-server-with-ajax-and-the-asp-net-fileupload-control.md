---
ID: 433
post_title: >
  Upload files to Microsoft Sharepoint
  Server with Ajax and the ASP .NET
  FileUpload control
author: Roel van Lisdonk
post_excerpt: ""
layout: post
permalink: >
  https://www.roelvanlisdonk.nl/2009/05/22/upload-files-to-microsoft-sharepoint-server-with-ajax-and-the-asp-net-fileupload-control/
published: true
post_date: 2009-05-22 11:18:49
---
<div class="padten">   <div class="ms-inputuserfield padfive seventyp">     <div>       <div class="ExternalClass0648DA365AC543C1A3989F51E0799CA6">         <p>The FileUpload control does not work with AJAX, because it needs a full postback to upload a file. So we have to change the AJAX partial postback to a full postback:           <br />            <br /><strong>ASPX, add a ScriptManager, UpdatePanel, FileUpload and LinkButton control:             <br /></strong><span lang="EN-US">             <br /></span><span style="line-height: 115%; font-family: &#39;Courier New&#39;; background: yellow; font-size: 10pt" lang="EN-US">&lt;%</span><span style="line-height: 115%; font-family: &#39;Courier New&#39;; color: blue; font-size: 10pt" lang="EN-US">@</span><span style="line-height: 115%; font-family: &#39;Courier New&#39;; font-size: 10pt" lang="EN-US"> <span style="color: #a31515">Page</span> <span style="color: red">Language</span><span style="color: blue">=&quot;C#&quot;</span> <span style="color: red">AutoEventWireup</span><span style="color: blue">=&quot;true&quot;</span> <span style="color: red">Codebehind</span><span style="color: blue">=&quot;Default.aspx.cs&quot;</span> <span style="color: red">Inherits</span><span style="color: blue">=&quot;WebApplicationCSharp._Default&quot;</span> <span style="background: yellow">%&gt;                <br />                <br />&lt;%</span><span style="color: blue">@</span> <span style="color: #a31515">Register</span> <span style="color: red">Assembly</span><span style="color: blue">=&quot;System.Web.Extensions, Version=1.0.61025.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35&quot;                <br /></span><span>&#160; </span><span style="color: red">Namespace</span><span style="color: blue">=&quot;System.Web.UI&quot;</span> <span style="color: red">TagPrefix</span><span style="color: blue">=&quot;asp&quot;</span> <span style="background: yellow">%&gt;                <br />&lt;%</span><span style="color: blue">@</span> <span style="color: #a31515">Register</span> <span style="color: red">Assembly</span><span style="color: blue">=&quot;Telerik.Web.UI&quot;</span> <span style="color: red">Namespace</span><span style="color: blue">=&quot;Telerik.Web.UI&quot;</span> <span style="color: red">TagPrefix</span><span style="color: blue">=&quot;telerik&quot;</span> <span style="background: yellow">%&gt;                <br /></span><span style="color: blue">&lt;!</span><span style="color: #a31515">DOCTYPE</span> <span style="color: red">html</span> <span style="color: red">PUBLIC</span> <span style="color: blue">&quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot;</span> <span style="color: blue">&quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;&gt;                <br />&lt;</span><span style="color: #a31515">html</span> <span style="color: red">xmlns</span><span style="color: blue">=&quot;http://www.w3.org/1999/xhtml&quot;&gt;                <br />&lt;</span><span style="color: #a31515">head</span> <span style="color: red">runat</span><span style="color: blue">=&quot;server&quot;&gt;                <br /></span><span>&#160; </span><span style="color: blue">&lt;</span><span style="color: #a31515">title</span><span style="color: blue">&gt;</span>Web app c#<span style="color: blue">&lt;/</span><span style="color: #a31515">title</span><span style="color: blue">&gt;                <br /></span><span>&#160; </span><span style="color: blue">&lt;</span><span style="color: #a31515">link</span> <span style="color: red">rel</span><span style="color: blue">=&quot;stylesheet&quot;</span> <span style="color: red">type</span><span style="color: blue">=&quot;text/css&quot;</span> <span style="color: red">href</span><span style="color: blue">=&quot;~/CustomStyles.css&quot;&gt;                <br />&lt;/</span><span style="color: #a31515">head</span><span style="color: blue">&gt;                <br />&lt;</span><span style="color: #a31515">body</span><span style="color: blue">&gt;                <br /></span><span>&#160; </span><span style="color: blue">&lt;</span><span style="color: #a31515">form</span> <span style="color: red">id</span><span style="color: blue">=&quot;form1&quot;</span> <span style="color: red">runat</span><span style="color: blue">=&quot;server&quot;&gt;                <br /></span><span>&#160;&#160;&#160; </span><span style="color: blue">&lt;</span><span style="color: #a31515">asp</span><span style="color: blue">:</span><span style="color: #a31515">ScriptManager</span> <span style="color: red">ID</span><span style="color: blue">=&quot;ScriptManagerTest&quot;</span> <span style="color: red">runat</span><span style="color: blue">=&quot;server&quot;&gt;                <br /></span><span>&#160;&#160;&#160; </span><span style="color: blue">&lt;/</span><span style="color: #a31515">asp</span><span style="color: blue">:</span><span style="color: #a31515">ScriptManager</span><span style="color: blue">&gt;                <br /></span><span>&#160;&#160;&#160; </span><span style="color: blue">&lt;</span><span style="color: #a31515">asp</span><span style="color: blue">:</span><span style="color: #a31515">UpdatePanel</span> <span style="color: red">ID</span><span style="color: blue">=&quot;UpdatePanelTest&quot;</span> <span style="color: red">runat</span><span style="color: blue">=&quot;server&quot;&gt;                <br /></span><span>&#160;&#160;&#160; </span><span style="color: blue">&lt;</span><span style="color: #a31515">ContentTemplate</span><span style="color: blue">&gt;                <br /></span><span>&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue">&lt;</span><span style="color: #a31515">asp</span><span style="color: blue">:</span><span style="color: #a31515">FileUpload</span> <span style="color: red">ID</span><span style="color: blue">=&quot;FileUploadTest&quot;</span> <span style="color: red">runat</span><span style="color: blue">=&quot;server&quot;</span> <span style="color: blue">/&gt;                <br /></span><span>&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue">&lt;</span><span style="color: #a31515">asp</span><span style="color: blue">:</span><span style="color: #a31515">LinkButton</span> <span style="color: red">ID</span><span style="color: blue">=&quot;LinkButtonTest&quot;</span> <span style="color: red">runat</span><span style="color: blue">=&quot;server&quot;</span> <span style="color: red">OnClick</span><span style="color: blue">=&quot;LinkButtonTest_Click&quot;&gt;</span>Test Upload<span style="color: blue">&lt;/</span><span style="color: #a31515">asp</span><span style="color: blue">:</span><span style="color: #a31515">LinkButton</span><span style="color: blue">&gt;                <br /></span><span>&#160;&#160;&#160; </span><span style="color: blue">&lt;/</span><span style="color: #a31515">ContentTemplate</span><span style="color: blue">&gt;                <br /></span><span>&#160;&#160;&#160; </span><span style="color: blue">&lt;/</span><span style="color: #a31515">asp</span><span style="color: blue">:</span><span style="color: #a31515">UpdatePanel</span><span style="color: blue">&gt;                <br /></span><span>&#160; </span><span style="color: blue">&lt;/</span><span style="color: #a31515">form</span><span style="color: blue">&gt;                <br />&lt;/</span><span style="color: #a31515">body</span><span style="color: blue">&gt;                <br />&lt;/</span><span style="color: #a31515">html</span><span style="color: blue">&gt;                <br /></span></span>            <br /><strong>Change Page_Load event             <br /></strong><span lang="EN-US">             <br /></span><span style="line-height: 115%; font-family: &#39;Courier New&#39;; color: blue; font-size: 10pt" lang="EN-US">protected</span><span style="line-height: 115%; font-family: &#39;Courier New&#39;; font-size: 10pt" lang="EN-US"> <span style="color: blue">void</span> Page_Load(<span style="color: blue">object</span> sender, <span style="color: #2b91af">EventArgs</span> e)               <br />{               <br /><span>&#160; </span><span style="color: green">// Disable AJAX for the<span>&#160;
</span>LinkButtonTest ONLY. Because we are using the FileUpload control, which does not work with AJAX, we need a full PostBack.                 <br /></span><span>&#160; </span>LinkButtonTest.Attributes.Add(<span style="color: #a31515">&quot;OnClick&quot;</span>, <span style="color: #2b91af">String</span>.Format(<span style="color: #a31515">&quot;form1.__EVENTTARGET.value = '{0}'; form1.submit(); return false;&quot;</span>, LinkButtonTest.UniqueID));               <br />}              <br />              <br /></span><strong>Add Click event on LinkButtonTest</strong><span lang="EN-US">             <br /></span><span style="line-height: 115%; font-family: &#39;Courier New&#39;; color: gray; font-size: 10pt" lang="EN-US">             <br />///</span><span style="line-height: 115%; font-family: &#39;Courier New&#39;; color: green; font-size: 10pt" lang="EN-US"> </span><span style="line-height: 115%; font-family: &#39;Courier New&#39;; color: gray; font-size: 10pt" lang="EN-US">&lt;summary&gt;              <br />///</span><span style="line-height: 115%; font-family: &#39;Courier New&#39;; color: green; font-size: 10pt" lang="EN-US"> The LinkButtonTest is on an AJAX update panel, but by overriding the OnClick event in the Page_Load event,              <br /></span><span style="line-height: 115%; font-family: &#39;Courier New&#39;; color: gray; font-size: 10pt" lang="EN-US">///</span><span style="line-height: 115%; font-family: &#39;Courier New&#39;; color: green; font-size: 10pt" lang="EN-US"> this event will fire with a full postback.              <br /></span><span style="line-height: 115%; font-family: &#39;Courier New&#39;; color: gray; font-size: 10pt" lang="EN-US">///</span><span style="line-height: 115%; font-family: &#39;Courier New&#39;; color: green; font-size: 10pt" lang="EN-US"> </span><span style="line-height: 115%; font-family: &#39;Courier New&#39;; color: gray; font-size: 10pt" lang="EN-US">&lt;/summary&gt;              <br />///</span><span style="line-height: 115%; font-family: &#39;Courier New&#39;; color: green; font-size: 10pt" lang="EN-US"> </span><span style="line-height: 115%; font-family: &#39;Courier New&#39;; color: gray; font-size: 10pt" lang="EN-US">&lt;param name=&quot;sender&quot;&gt;&lt;/param&gt;              <br />///</span><span style="line-height: 115%; font-family: &#39;Courier New&#39;; color: green; font-size: 10pt" lang="EN-US"> </span><span style="line-height: 115%; font-family: &#39;Courier New&#39;; color: gray; font-size: 10pt" lang="EN-US">&lt;param name=&quot;e&quot;&gt;&lt;/param&gt;              <br /></span><span style="line-height: 115%; font-family: &#39;Courier New&#39;; color: blue; font-size: 10pt" lang="EN-US">protected</span><span style="line-height: 115%; font-family: &#39;Courier New&#39;; font-size: 10pt" lang="EN-US"> <span style="color: blue">void</span> LinkButtonTest_Click(<span style="color: blue">object</span> sender, <span style="color: #2b91af">EventArgs</span> e)               <br />{               <br /><span>&#160; </span><span style="color: blue">this</span>.UploadFile();               <br />}</span><span lang="EN-US">              <br />              <br /></span><strong>Add an UploadFile function             <br /></strong><span lang="EN-US">             <br /></span><span style="line-height: 115%; font-family: &#39;Courier New&#39;; color: blue; font-size: 10pt" lang="EN-US">public</span><span style="line-height: 115%; font-family: &#39;Courier New&#39;; font-size: 10pt" lang="EN-US"> <span style="color: blue">void</span> UploadFile()               <br />{               <br /><span>&#160; </span><span style="color: blue">using</span> (<span style="color: #2b91af">SPSite</span> sitecollection = <span style="color: blue">new</span> <span style="color: #2b91af">SPSite</span>(<span style="color: #a31515">&quot;http://localhost&quot;</span>))               <br /><span>&#160; </span>{               <br /><span>&#160;&#160;&#160; </span><span style="color: blue">using</span> (<span style="color: #2b91af">SPWeb</span> web = sitecollection.RootWeb)               <br /><span>&#160;&#160;&#160; </span>{               <br /><span>&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue">if</span> (FileUploadTest.HasFile)               <br /><span>&#160;&#160;&#160;&#160;&#160; </span>{               <br /><span>&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue">using</span> (<span style="color: #2b91af">Stream</span> fileContent = FileUploadTest.FileContent)               <br /><span>&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span>{               <br /><span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue">string</span> fileName = FileUploadTest.FileName;               <br /><span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue">string</span> newListItemImageName = <span style="color: #a31515">&quot;&quot;</span>;<span style="color: green">&#160; <br /></span><span>&#160;&#160; </span><span>&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green">// Get list by name                <br /></span><span>&#160;&#160; </span><span>&#160; </span><span>&#160;&#160;&#160;&#160; </span><span style="color: #2b91af">SPList</span> list = web.Lists[listName];               <br /><span>&#160; </span><span>&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green">// Get rootfolder of the list                <br /></span><span>&#160; </span><span>&#160; </span><span>&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af">SPFolder</span> folder = list.RootFolder;               <br /><span>&#160; </span><span>&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green">// Delete the current file if it exists. I can't find a way to check the existence of a file without an exception and not looping through all the items in the list.                <br /></span><span>&#160; </span><span>&#160; </span><span>&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue">bool</span> fileExists = <span style="color: blue">false</span>;               <br /><span>&#160;&#160;&#160; </span><span>&#160; </span><span>&#160;&#160;&#160; </span><span style="color: #2b91af">SPFile</span> currentFile = <span style="color: blue">null</span>;               <br /><span>&#160;&#160;&#160;&#160;&#160; </span><span>&#160; </span><span>&#160; </span><span style="color: blue">try                <br /></span><span>&#160;&#160;&#160; </span><span>&#160; </span><span>&#160;&#160;&#160; </span>{               <br /><span>&#160;&#160;&#160;&#160; </span><span>&#160; </span><span>&#160;&#160;&#160;&#160; </span>currentFile = folder.Files[fileName];               <br /><span>&#160;&#160;&#160;&#160;&#160; </span><span>&#160; </span><span>&#160;&#160;&#160; </span>fileExists = <span style="color: blue">true</span>;               <br /><span>&#160;&#160;&#160;&#160; </span><span>&#160; </span><span>&#160;&#160; </span>}               <br /><span>&#160;&#160;&#160;&#160;&#160; </span><span>&#160; </span><span>&#160; </span><span style="color: blue">catch</span> { fileExists = <span style="color: blue">false</span>; }               <br /><span>&#160;&#160;&#160;&#160;&#160; </span><span>&#160; </span><span>&#160; </span><span style="color: blue">if</span> (fileExists) { currentFile.Delete(); }               <br /><span>&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span>&#160; </span><span style="color: green">// Add file to the list                <br /></span><span>&#160; </span><span>&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span>currentFile = folder.Files.Add(<span style="color: #2b91af">String</span>.Format(<span style="color: #a31515">&quot;{0}/{1}&quot;</span>, folder.ServerRelativeUrl, fileName), fileContent);               <br /><span>&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span>}               <br /><span>&#160;&#160;&#160;&#160;&#160; </span>}               <br /><span>&#160;&#160;&#160; </span>}               <br /><span>&#160; </span>}               <br />}</span><span lang="EN-US">              <br /></span></p>       </div>     </div>
 </div> </div>