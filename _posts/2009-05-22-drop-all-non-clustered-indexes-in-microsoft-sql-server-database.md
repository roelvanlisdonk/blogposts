---
ID: 420
post_title: >
  Drop all non clustered indexes in
  Microsoft SQL Server database
author: Roel van Lisdonk
post_excerpt: ""
layout: post
permalink: >
  https://www.roelvanlisdonk.nl/2009/05/22/drop-all-non-clustered-indexes-in-microsoft-sql-server-database/
published: true
post_date: 2009-05-22 08:36:20
---
<div class="padten">   <div class="ms-inputuserfield padfive seventyp">     <div>       <div class="ExternalClassEA8148F1B23B4A7BA621CE35E56A361F">         <p><span style="font-family: courier new; color: blue"><span style="font-size: 9pt">if</span></span><span style="font-size: 9pt"><span style="font-family: courier new"> <span style="color: gray">exists</span> <span style="color: gray">(</span><span style="color: blue">select</span> <span style="color: gray">*</span> <span style="color: blue">from</span> [tempdb]<span style="color: gray">.</span>[dbo]<span style="color: gray">.</span>sysobjects <span style="color: blue">where</span> id <span style="color: gray">=</span> <span style="color: fuchsia">object_id</span><span style="color: gray">(</span>N<span style="color: red">'[tempdb].[dbo].[##NonClusteredIndexesToDelete]'</span><span style="color: gray">))                 <br /></span>&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">drop</span> <span style="color: blue">table</span> ##NonClusteredIndexesToDelete                <br />                <br /><span style="color: blue">create</span> <span style="color: blue">Table</span> ##NonClusteredIndexesToDelete                <br />&#160;&#160;&#160; <span style="color: gray">(</span>[Name] <span style="color: blue">sysname</span><span style="color: gray">,</span> [TableName] <span style="color: blue">sysname</span><span style="color: gray">)                 <br />                  <br /></span><span style="color: blue">insert</span> ##NonClusteredIndexesToDelete                <br /><span style="color: blue">select</span>                 <br />&#160;&#160;&#160; sysindexes<span style="color: gray">.</span>[name]<span style="color: gray">,                 <br /></span>&#160;&#160;&#160; sysobjects<span style="color: gray">.</span>[name] <span style="color: blue">as</span> TableName                <br /><span style="color: blue">from</span>                 <br />&#160;&#160;&#160; sysindexes <span style="color: gray">(</span>nolock<span style="color: gray">)                 <br />inner</span> <span style="color: gray">join                 <br /></span>&#160;&#160;&#160; sysobjects <span style="color: blue">on</span> sysindexes<span style="color: gray">.</span>id <span style="color: gray">=</span> sysobjects<span style="color: gray">.</span>id                <br /><span style="color: blue">where</span>&#160;&#160;&#160; <span style="color: gray">(</span>indid <span style="color: gray">&gt;</span> 1<span style="color: gray">)</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">-- delete only non clustered indexes                 <br /></span><span style="color: gray">and</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: gray">(</span>sysindexes<span style="color: gray">.</span>[name] <span style="color: gray">not</span> <span style="color: gray">like</span> <span style="color: red">'_WA%'</span><span style="color: gray">)</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">-- don't delete statistics                 <br /></span><span style="color: gray">and</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: gray">(</span>sysobjects<span style="color: gray">.</span>[type] <span style="color: gray">!=</span> <span style="color: red">'S'</span><span style="color: gray">)</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">-- don't delete system indexes                 <br /></span><span style="color: gray">and</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: gray">(</span>sysobjects<span style="color: gray">.</span>[xtype] <span style="color: gray">!=</span> <span style="color: red">'IT'</span><span style="color: gray">)</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">-- don't delete system indexes                 <br /></span><span style="color: gray">and</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: gray">(not(</span>sysindexes<span style="color: gray">.</span>[status] <span style="color: gray">=</span> 4098 <span style="color: gray">and</span> sysindexes<span style="color: gray">.</span>indid <span style="color: gray">=</span> 2<span style="color: gray">))</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">-- don't delete unique indexes                 <br /></span><span style="color: blue">order</span> <span style="color: blue">by</span> <span style="color: gray">(</span>sysindexes<span style="color: gray">.</span>[name]<span style="color: gray">)                 <br />                  <br /></span><span style="color: blue">declare</span> @name <span style="color: blue">sysname                 <br />declare</span> @TableName <span style="color: blue">sysname                 <br />declare</span> @sql <span style="color: blue">varchar</span><span style="color: gray">(</span>4096<span style="color: gray">)                 <br /></span><span style="color: blue">declare</span> vCursor <span style="color: blue">cursor</span> <span style="color: blue">for                 <br /></span>&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">select</span> [name]<span style="color: gray">,</span> [TableName] <span style="color: blue">from</span> ##NonClusteredIndexesToDelete <span style="color: blue">order</span> <span style="color: blue">by</span> [name]                <br />                <br /><span style="color: blue">open</span> vCursor                <br /><span style="color: blue">fetch</span> NEXT <span style="color: blue">from</span> vCursor <span style="color: blue">into</span> @name<span style="color: gray">,</span> @TableName                <br /><span style="color: blue">while</span> <span style="color: fuchsia">@@FETCH_STATUS</span> <span style="color: gray">=</span> 0                <br />&#160;&#160;&#160; <span style="color: blue">begin                 <br /></span>&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">set</span> @sql <span style="color: gray">=</span> <span style="color: red">'drop index '</span> <span style="color: gray">+</span> @TableName <span style="color: gray">+</span> <span style="color: red">'.'</span> <span style="color: gray">+</span> @name                <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">exec</span> <span style="color: gray">(</span>@sql<span style="color: gray">)                 <br /></span>&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">fetch</span> NEXT <span style="color: blue">from</span> vCursor <span style="color: blue">into</span> @name<span style="color: gray">,</span> @TableName                <br />&#160;&#160;&#160; <span style="color: blue">End</span>&#160;&#160;&#160;&#160; <br />                <br /><span style="color: blue">close</span> vCursor                <br /><span style="color: blue">deallocate</span> vCursor                <br />                <br /><span style="color: blue">drop</span> <span style="color: blue">table</span> ##NonClusteredIndexesToDelete</span>              <br /></span></p>       </div>     </div>     <span class="blankline"></span></div> </div>