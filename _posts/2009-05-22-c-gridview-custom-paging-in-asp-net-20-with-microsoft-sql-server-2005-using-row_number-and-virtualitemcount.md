---
ID: 416
post_title: 'C# &#8211; GridView &#8211; Custom Paging in ASP .NET 2.0 with Microsoft SQL Server 2005 using ROW_NUMBER() and VirtualItemCount'
author: Roel van Lisdonk
post_excerpt: ""
layout: post
permalink: >
  https://www.roelvanlisdonk.nl/2009/05/22/c-gridview-custom-paging-in-asp-net-20-with-microsoft-sql-server-2005-using-row_number-and-virtualitemcount/
published: true
post_date: 2009-05-22 07:58:42
---
<p></p>  <div class="padten">   <div class="ms-inputuserfield padfive seventyp">     <div>       <div class="ExternalClassBE1408A90A5949B1A27B64EAF0E69E26">         <p>Add a datagrid to your aspx page.           <br />Set the following properties in the designer:            <br /><span style="font-family: courier new; font-size: 10pt"><span style="color: red">AutoGenerateColumns</span><span style="color: blue">=&quot;false&quot;               <br /></span>&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: red">AllowPaging</span><span style="color: blue">=&quot;true&quot;</span>               <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: red">AllowCustomPaging</span><span style="color: blue">=&quot;true&quot;               <br /></span>&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: red">AllowSorting</span><span style="color: blue">=&quot;false&quot;</span></span>            <br />            <br /><span style="font-family: courier new; font-size: 10pt"><span style="color: blue">&lt;</span><span style="color: #a31515">asp</span><span style="color: blue">:</span><span style="color: #a31515">DataGrid</span>               <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: red">ID</span><span style="color: blue">=&quot;dg&quot;               <br /></span>&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: red">AutoGenerateColumns</span><span style="color: blue">=&quot;false&quot;               <br /></span>&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: red">AllowPaging</span><span style="color: blue">=&quot;true&quot;</span>               <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: red">AllowCustomPaging</span><span style="color: blue">=&quot;true&quot;               <br /></span>&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: red">AllowSorting</span><span style="color: blue">=&quot;false&quot;               <br /></span>&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: red">DataKeyField</span><span style="color: blue">=&quot;Id&quot;               <br /></span>&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: red">OnPageIndexChanged</span><span style="color: blue">=&quot;dgZendingen_PageIndexChanged&quot;</span>               <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: red">runat</span><span style="color: blue">=&quot;server&quot;               <br /></span>&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: red">PageSize</span><span style="color: blue">=&quot;20&quot;&gt;</span></span>            <br />            <br />Add the pagerstyle to the datagrid            <br /><span style="font-family: courier new; font-size: 10pt"><span style="color: blue">&lt;</span><span style="color: #a31515">PagerStyle</span> <span style="color: red">PageButtonCount</span><span style="color: blue">=&quot;10&quot;</span> <span style="color: red">Mode</span><span style="color: blue">=&quot;NumericPages&quot;&gt;&lt;/</span><span style="color: #a31515">PagerStyle</span><span style="color: blue">&gt;</span></span>            <br />            <br />            <br />Add the following events             <br />            <br /><span style="font-family: courier new; font-size: 10pt"><span style="color: blue">protected</span> <span style="color: blue">void</span> dgZendingen_PageIndexChanged(<span style="color: blue">object</span> source, <span style="color: #2b91af">DataGridPageChangedEventArgs</span> e)              <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {              <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; dgZendingen.CurrentPageIndex = e.NewPageIndex;              <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">this</span>.BindDataGrid();              <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span>            <br />            <br />And Functions            <br />            <br /><span style="font-family: courier new; font-size: 10pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: blue">void</span> BindDataGrid()              <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {              <br />              <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">int</span> startindex = 1;              <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (dg.CurrentPageIndex &gt; 0)              <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {              <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; startindex = (dg.PageSize * dg.CurrentPageIndex) + 1;              <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }              <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">else               <br /></span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {              <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; startindex = 1;              <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }              <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ds = // get subset of items with sp pSubSetItemsSelect;              <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (dg.CurrentPageIndex == 0)              <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {              <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; dg.VirtualItemCount = // get total item count with sp pTotalCount;               <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }              <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <br />              <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">DataView</span> dv = ds.Tables[0].DefaultView;              <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; dgZendingen.DataSource = dv;              <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; dgZendingen.DataBind();              <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span>            <br />            <br />            <br />Create 2 stored procedures, the first to calculate the total item count and the second to get the subset of items            <br />            <br /><strong>First sp</strong>            <br /><span style="font-family: courier new; font-size: 10pt"><span style="color: blue">if</span> <span style="color: gray">exists</span> <span style="color: gray">(</span><span style="color: blue">select</span> <span style="color: gray">*</span> <span style="color: blue">from</span> dbo<span style="color: gray">.</span>sysobjects <span style="color: blue">where</span> <span style="color: blue">name</span> <span style="color: gray">=</span> <span style="color: red">'pTotalCount'</span> <span style="color: gray">and</span> xtype <span style="color: gray">=</span> <span style="color: red">'p'</span><span style="color: gray">)               <br /></span>&#160;&#160;&#160; <span style="color: blue">drop</span> <span style="color: blue">procedure</span> pTotalCount              <br />go              <br />              <br /><span style="color: blue">create</span>&#160;&#160;&#160; <span style="color: blue">procedure</span> pTotalCount              <br /><span style="color: blue">as               <br />begin                <br />                <br /></span>&#160;&#160;&#160; <span style="color: blue">declare</span> @totalCount <span style="color: blu
e">int               <br /></span>&#160;&#160;&#160; <span style="color: blue">set</span> @totalCount <span style="color: gray">=</span> 0&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <br />&#160;&#160;&#160; <span style="color: blue">select</span> @totalCount <span style="color: gray">=</span> <span style="color: fuchsia">count</span><span style="color: gray">(</span>1<span style="color: gray">)               <br /></span>&#160;&#160;&#160; <span style="color: blue">from</span>               <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; Table1 t <span style="color: gray">(</span>nolock<span style="color: gray">)               <br /></span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <br /><span style="color: blue">end               <br /></span>go</span>            <br />            <br />            <br /><strong>Second Sp</strong>            <br />            <br /><span style="font-family: courier new; font-size: 10pt">             <br /><span style="color: blue">if</span> <span style="color: gray">exists</span> <span style="color: gray">(</span><span style="color: blue">select</span> <span style="color: gray">*</span> <span style="color: blue">from</span> dbo<span style="color: gray">.</span>sysobjects <span style="color: blue">where</span> <span style="color: blue">name</span> <span style="color: gray">=</span> <span style="color: red">'pSubSetItemsSelect'</span> <span style="color: gray">and</span> xtype <span style="color: gray">=</span> <span style="color: red">'p'</span><span style="color: gray">)               <br /></span>&#160;&#160;&#160; <span style="color: blue">drop</span> <span style="color: blue">procedure</span> pSubSetItemsSelect              <br />go              <br />              <br /><span style="color: blue">create</span>&#160;&#160;&#160; <span style="color: blue">procedure</span> pSubSetItemsSelect              <br />&#160;&#160;&#160; @MaxItemsOnPage <span style="color: blue">int</span> <span style="color: gray">=</span> 20<span style="color: gray">,               <br /></span>&#160;&#160;&#160; @StartIndex <span style="color: blue">int</span> <span style="color: gray">=</span> 0              <br /><span style="color: blue">as               <br />begin                <br />                <br /></span>&#160;&#160;&#160; <span style="color: blue">select</span> DerivedTable<span style="color: gray">.</span>RowNum<span style="color: gray">,</span> DerivedTable<span style="color: gray">.</span>Id<span style="color: gray">,</span> DerivedTable<span style="color: gray">.</span>[Message]              <br />&#160;&#160;&#160; <span style="color: blue">from               <br /></span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: gray">(               <br /></span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">select</span> row_number<span style="color: gray">()</span> <span style="color: blue">over</span><span style="color: gray">(</span><span style="color: blue">order</span> <span style="color: blue">by</span> [Message]<span style="color: gray">)</span> <span style="color: blue">as</span> RowNum<span style="color: gray">,</span> Table1<span style="color: gray">.</span>Id<span style="color: gray">,</span> Table1<span style="color: gray">.</span>[Message]              <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">from</span>               <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Table1 t <span style="color: gray">(</span>nolock<span style="color: gray">)               <br /></span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: gray">)</span> <span style="color: blue">as</span> DerivedTable              <br />&#160;&#160;&#160; <span style="color: blue">where</span> RowNum <span style="color: gray">between</span> @StartIndex <span style="color: gray">and</span> <span style="color: gray">(</span>@StartIndex <span style="color: gray">+</span> @MaxItemsOnPage<span style="color: gray">)</span> <span style="color: gray">-</span> 1              <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <br /><span style="color: blue">end               <br /></span>go</span>            <br />            <br /></p>       </div>     </div>   </div> </div>