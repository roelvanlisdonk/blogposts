---
ID: 1530
post_title: >
  How to native boot Windows 7 from vhd
  (hyper-v) on an other machine with RAID,
  without getting the BSOD (blue screen of
  death)
author: Roel van Lisdonk
post_excerpt: ""
layout: post
permalink: >
  https://www.roelvanlisdonk.nl/2010/06/22/how-to-native-boot-windows-7-from-vhd-hyper-v-on-an-other-machine-with-raid-without-getting-the-bsod-blue-screen-of-death/
published: true
post_date: 2010-06-22 13:57:10
---
<p>I wanted to create one virtual machine and use (boot)&#160; it on an other machine, but I was getting a Blue Screen Of Death (BSOD) every time I booted the virtual machine, even if I created the VHD in the Microsoft Windows 2008 R2 Hyper-V manager and tried to natively boot on that same machine from the virtual machine.</p>  <p><strong><font size="3">Cause</font></strong></p>  <p>This was caused by the fact that I was using a RAID configuration on Machine A and also on Machine B and the RAID drivers where not supplied on the Windows 7 DVD. All drivers needed to boot Microsoft Windows 7 should be available on the virtual machine before you try to boot from the vhd.</p>  <p>&#160;</p>  <p><strong><font size="3">Solution</font></strong></p>  <p>Even if you are not using RAID configuration, best practice is to sysprep you’re virtual machine before you try to boot it on an other machine. If you’re using a RAID configuration, special graphics drivers or other drivers not on the Microsoft Windows 7 DVD, use dism.exe found in the “Windows Automated Installation Kit (AIK) for Windows® 7” to add drivers to you’re syspreped vhd.</p>  <p>These are the steps I used to boot from a VHD containing Microsoft Windows 2008 R2 or Microsoft Windows 7 on an other machine without getting the BSOD:</p>  <p>&#160;</p>  <p><strong><font size="3">Creating the Virtual Machine</font></strong></p>  <ul>   <li><strong>Machine A</strong> has Microsoft Windows 2008 R2 with hyper-v role installed</li>    <li>Create a <strong>Virtual Machine</strong> on <strong>Machine A</strong>, by using the hyper-v manager (Start &gt; Administrative Tools &gt; Server Manager &gt; Roles &gt; Hyper-V Manager. Make sure the disk is fixed to a maximum size (for example: 50GB). <strong>Machine B</strong> should have at least 50GB free disk space else the vhd won’t boot.</li>    <li>     <div align="left">Create the virtual machine on C:\VHD\NotSysPreped, path to VHD should be C:\VHD\<strong>NotSysPreped</strong>\MyMachine.vhd</div>   </li>    <li>     <div align="left">After installing Windows 7 or Windows Server 2008 R2 on it and after installing all you’re programs (except anti virus), shutdown the virtual machine</div>   </li>    <li>     <li>       <div align="left">Download the Windows Automated Installation Kit (AIK) for Windows® 7 :<a title="http://www.microsoft.com/downloads/details.aspx?familyid=696DD665-9F76-4177-A811-39C26D3B3B34&amp;displaylang=en" href="http://www.microsoft.com/downloads/details.aspx?familyid=696DD665-9F76-4177-A811-39C26D3B3B34&amp;displaylang=en">http://www.microsoft.com/downloads/details.aspx?familyid=696DD665-9F76-4177-A811-39C26D3B3B34&amp;displaylang=en</a></div>     </li>      <li>       <div align="left">Install the Windows Automated Installation Kit (AIK) for Windows® 7 on <strong>Machine A</strong>, because we need the dism.exe tool. You could also use a tool like Virtual CloneDrive to copy the tool out of the downloaded *.iso file.</div>     </li>   </li>    <li>     <div align="left">I will boot this virtual machine once a week to update it with the last Windows Updates (keeping this Virtual Machine up to date)</div>   </li> </ul>  <p align="left">&#160;</p>  <p align="left"><strong><font size="3">Pre-pair the Virtual Machine</font></strong> </p>  <p align="left">Every time you want to use a copy of this virtual machine on other machine, execute the following steps:</p>  <ul>   <li>     <div align="left">Shutdown the Virtual Machine on <strong>Machine A</strong></div>   </li>    <li>     <div align="left">Copy the file C:\VHD\NotSysPreped\MyMachine.vhd to C:\VHD\<strong>SysPreped</strong>\MyMachine.vhd. We create a copy of the vhd, because we want the original virtual machine to keep working.</div>   </li>    <li>     <div align="left">Create a new Virtual Machine based on the copied C:\VHD\<strong>SysPreped</strong>\MyMachine.vhd file</div>   </li>    <li>     <div align="left">Boot this new <strong>Virtual Machine</strong></div>   </li>    <li>In the <strong>Virtual Machine</strong> execute C:\Windows\System32\sysprep\sysprep.exe</li>    <li><a href="http://www.roelvanlisdonk.nl/wp-content/uploads/2010/06/image13.png"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="image" border="0" alt="image" src="http://www.roelvanlisdonk.nl/wp-content/uploads/2010/06/image_thumb13.png" width="504" height="379" /></a> </li>    <li>Choose Enter System Out-of-Box Experience (OOBE)</li>    <li>Check “Generalize”</li>    <li>Choose “Shutdown” </li>    <li>Press OK</li> </ul>  <p>The following steps are only needed when you are using drivers on <strong>Machine B</strong>, that are not supplied on the Windows 7 DVD (for example: when you are using a RAID configuration).</p>  <ul>   <li>     <div align="left"><font color="#800000">After the virtual machine has shutdown</font>, run CMD on <strong>Machine A</strong></div>   </li>    <li>     <div align="left">Attach the C:\VHD\<strong>SysPreped</strong>\MyMachine.vhd file, so it can be used by the dism.exe tool:</div>   </li>    <ul>     <li>       <div align="left">In the cmd dialog enter:</div>     </li>      <li>       <div align="left">diskpart</div>     </li>      <li>       <div align="left">select vdisk file=C:\VHD\<strong>SysPreped</strong>\MyMachine.vhd </div>     </li>      <li>       <div align="left">attach vdisk</div>     </li>      <li>       <div align="left">assign letter=v</div>     </li>      <li>       <div align="left">exit</div>     </li>   </ul>    <li>     <div align="left">Copy you’re RAID drivers to Machine A on C:\Drivers</div>   </li>    <li>     <div align="left">Add RAID drivers by using the dism.exe tool:</div>   </li>    <ul>     <li>       <div align="left">In the cmd dialog enter:</div>     </li>      <li>       <p>dism.exe /image:V:\ /Add-Driver /driver:C:\Drivers\mydriver.inf</p>     </li>   </ul> </ul>  <p>&#160;</p>  <p><strong><font size="3">Booting from the Virtual Machine on Machine B</font></strong></p>  <ul>   <li>     <div align="left"><strong>Machine B</strong> must be running Windows Server 2008 R2 or Windows 7</div>   </li>    <li>     <div align="left">Boot <strong>Machine B</strong></div>   </li>    <li>     <div align="left">Copy the C:\VHD\<strong>SysPreped</strong>\MyMachine.vhd from <strong>Machine A</strong> to <strong>Machine B</strong> C:\VHD\<strong>SysPreped</strong>\MyMachine.vhd</div>   </li>    <li>     <div align="left">Edit the boot manager by using the bcdedit.exe tool:</div>   </li>    <ul>     <li>       <div align="left">bcdedit /copy {current} /d “<strong>MyMachine Description</strong>”</div>     </li>      <li>       <div align="left">The previous statement returns a GUID like: {aa2e3972-7a31-11df-987b-b52175dc348f}</div>     </li>      <li>       <div align="left">bcdedit /set {aa2e3972-7a31-11df-987b-b52175dc348f} device vhd=[C:]\VHD\SysPreped\MyMachine.vhd </div>     </li>      <li>       <div align="left">bcdedit /set {aa2e3972-7a31-11df-987b-b52175dc348f} osdevice vhd=[C:]\VHD\SysPreped\MyMachine.vhd</div>     </li>      <li>       <div align="left">bcdedit /set {aa2e3972-7a31-11df-987b-b52175dc348f} detecthal on</div>     </li>      <li>       <div align="left">bcdedit /set hypervisorlaunchtype auto</div>     </li>      <li>       <div align="left">The previous statement is only needed when the virtual machine is running Microsoft Windows 2008 R2 with the hyper-v role enabled.</div>     </li>   </ul>    <li>     <div align="left">Reboot Machine B</div>   </li>    <li>     <div align="left">After rebooting you should see two entries one with the description “Windows 7” and an other with the description “<strong>MyMachine Description</strong>”</div>   </li>    <li>     <div align="left">You should now be able to boot the virtual machine on Machine B without getting the BSOD!</div>   </li> </ul>