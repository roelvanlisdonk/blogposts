---
ID: 4808
post_title: >
  Micro services in the real world, by
  Pieter Joost van de Sande, what a great
  talk!!
author: Roel van Lisdonk
post_excerpt: ""
layout: post
permalink: >
  https://www.roelvanlisdonk.nl/2016/02/19/micro-services-in-de-real-world-by-pieter-joost-van-de-sande-what-a-great-talk/
published: true
post_date: 2016-02-19 11:05:52
---
<p align="left">Sometimes, when you listen to a talk a light will go off, in this case it was more like a lighthouse. </p> <p align="left">Pieter Joost van de Sande gave a <a href="https://www.isense.nl/microservices">talk</a> yesterday, about micro services.  <p align="left">&nbsp; <p align="left"><strong>What a great talk!</strong>  <p align="left">&nbsp; <p align="left">Some short notes I took during his talk (not necessarily the things Joost said and all references to businesses and persons are fictional).  <p align="left">&nbsp; <p align="left"><strong>What is the size of a micro service?</strong>  <p align="left">About a max size of 1000 rows of GO code.  <p align="left">So you should make a micro service based on the smallest consistent boundary.  <p align="left">Albert Einstein once said: make it as simple as possible but no simpler.  <p align="left">Joost said: make it as small as possible but not smaller.  <p align="left">&nbsp; <p align="left"><strong>What should NOT be a micro service?</strong>  <p align="left">Business entity are NOT a great base for micro service, because they are needed by multiple micro services. Instead use technical concepts as a micro service base.  <p align="left">&nbsp; <p align="left">Good candidates are:  <ul> <li> <div align="left">Registration</div> <li> <div align="left">Profile</div> <li> <div align="left">Online</div> <li> <div align="left">Matching</div></li></ul> <p align="left">&nbsp; <p align="left">Do NOT use:  <ul> <li> <div align="left">Company</div> <li> <div align="left">Contact</div> <li> <div align="left">Document</div> <li> <div align="left">User</div></li></ul> <p align="left">&nbsp;&nbsp;&nbsp; <p align="left"><strong>There will be only one micro service responsible for the quality of a specific part of the data</strong>  <p align="left">Data will be replicated in many services, but there will only be one service responsible for the quality of a specific part of the data.  <p align="left">E.g. if the registration service fires an event, that an user is registered with nickname: bigelefant, then all other services that depend on this data will be receive this specific event and they can't argue that the event happened or that the data in the event is not correct.  <p align="left">It happened, so it is true!  <p align="left">&nbsp; <p align="left"><strong>How do you scale 1 micro services?</strong>  <p align="left">Sharding!  <p align="left">&nbsp; <p align="left">By using sharding. So all users with a nickname starting with an "A" go to registration service instance A and all users with a nickname starting with a "B" go to registration service B.  <p align="left">One note on sharding, you can't do sharding on 2 different keys. If you want to shard the data on nickname and email (to guarantee unique nicknames and unique email addresses), then you should create 3 micro services, the first shards on nickname the second on email and de third service will gather both events and will be responsible for acknowledgements of the uniqueness of both keys.  <p align="left">&nbsp;&nbsp;&nbsp; <p align="left"><strong>Which tool did you use for requirements gathering?</strong>  <p align="left">Event storming by Alberto Brendolini (<a href="http://ziobrando.blogspot.nl/2013/11/introducing-event-storming.html">http://ziobrando.blogspot.nl/2013/11/introducing-event-storming.html</a>).  <p align="left">&nbsp;&nbsp;&nbsp; <p align="left"><strong>Do NOT use queues, use persistent streams</strong>  <p align="left">Queues destroy data, by using persistent streams you can always continue where you left of.  <p align="left">&nbsp; <p align="left"><strong>Micro services do not have dependencies</strong>  <p align="left">Well this is not entirely true, when a micro service goes down and comes up again, it will ask the event stream system to play back all events it missed during it's down time, so each micro service has a dependency on the event stream system, but there are 2 reasons, why this dependency is not a problem.  <ul> <li> <div align="left">First, the event stream system is constructed of many independent event streams and an event stream is just an immutable (append only) file on disk.</div> <li> <div align="left">Second, the event streams are stored on a google file system, that is guaranteed to have a 100% up time.</div></li></ul> <p align="left">&nbsp; <p align="left"><strong>There are 2 things hard in software engineering: naming things and caching invalidation</strong>  <p align="left">Well the last part is solved in this micro services architecture by using immutable append only files. When something is immutable you can cache it indefinitely.  <p align="left">&nbsp; <p align="left"><strong>What is the data size increase factor by using denormalized replicated data?</strong>  <p align="left">Well in our case the total factor was about 200x!  <p align="left">But disk space is really really really cheap and the reducement in complexity is immense.  <p align="left">You gain a lot of flexibility and are much better prepared to scale your system.  <p align="left">&nbsp;&nbsp;&nbsp; <p align="left"><strong>How do you deal with configuration changes?</strong>  <p align="left">We use a micro service for that :-)  <p align="left">The configuration service fires an event, when configuration changes. These events are received by all micro services that use that specific part of the configuration.  <p align="left">&nbsp; <p align="left">&nbsp; <p align="left"><strong>What is the greatest challenge, when working with a micro services architecture?</strong>  <p align="left">Eventual consistency!  <p align="left">&nbsp; <p align="left">When using a micro services architecture, specific data will not be immediately updated on all micro services.  <p align="left">You can't change specific data at a specific moment in time for the whole system.  <p align="left">Data will updated like a wave, but eventually all micro services will get the new data.  <p align="left">&nbsp; <p align="left"><strong>What besides using a micro services architecture, do you use to increase system availability?</strong>  <p align="left">Service degradation!  <p align="left">&nbsp; E.g. we first ask the platinum online service to give a list of interesting people that are oneline, this service will take in to account geolocation and all kind of other metrics, when the service does not respond in 50ms we ask a the normal online service to give a list of people, this service will only take in to account gender en age, when this service does not respond in 100ms, Google adds will be displayed, so we earn by having our services offline :-).  <p align="left">&nbsp; <p align="left"><strong>How do you deal with different versions of different micro services?</strong>  <p align="left">We don't have different versions!  <p align="left">We deploy the system as one big monolith.  <p align="left">All code lives in one big GIT repository and we have 3 branches:  <ul> <li> <div align="left">Main</div> <li> <div align="left">A</div> <li> <div align="left">B</div></li></ul> <p align="left">The branches A and B are for A-B testing.  <p align="left">We don't use semantic versioning any more.  <p align="left">The system has a version, but this is just a counter.  <p align="left">When we deploy, the whole system is deployed to 5% off all users and steadily increased, when errors are found in the log the system will automatically rollback the deployment.  <p align="left">All deployments are stored.  <p align="left">&nbsp; <p align="left">&nbsp; <p align="left"><strong>How do you deal with different versions of events?</strong>  <p align="left">We make the schema of our events backwards compatible, but sometimes this does not work.  <p align="left">In 2 cases we even asked the user to supply data, because we wanted to add a new property and we didn't know what the default value should be for the existing property in that case, we had to ask the user, when the user signed in, he or she was asked a question, the answer was the default value for the new property.  <p align="left">&nbsp;&nbsp;&nbsp; <p align="left"><strong>Some people say you must not put data in an event only "keys"?</strong>  <p align="left">We put as much data as possible in an event, because these events are shared by the micro services, when a micro service needs a specific part of the data and only has the key of this data it must ask another service for this data, hence you get the SOA dependency hell.  <p align="left">Data that is not of interest for the micro service that produces the event, can be of vital importance for another micro service, so we put as much as possible all data in an event.  <p align="left">&nbsp; <p align="left"><strong>How do you deal with planning?</strong>  <p align="left">We don't plan.  <p align="left">&nbsp; <p align="left">You as a software engineer deliver value by increasing quality of the code or by adding new features, that's the only thing that counts.  <p align="left">If your manager ask, when will this new and great part of the system be ready, you see, I can't tell you.  <p align="left">You do requirements gathering and start to build, then by delivering working software you can steadily get a notion, when parts will be ready.  <p align="left">It's ready, when it is ready.  <p align="left">&nbsp; <p align="left"><strong>How do you take on testing and documentation?</strong>  <p align="left">We don't test  <p align="left">Well this is not entirely true, for each micro service we describe (in GO code) which events go in and which events go out. This delivers executable code, that can check if the micro service behaves like it should and delivers documentation about, how the system works.  <p align="left">&nbsp;&nbsp;&nbsp; <p align="left"><strong>Bugs are our highest priority!</strong>  <p align="left">When an bug that impacts the user is encountered all is dropped en the bug is tackled immediately.  <p align="left">When you have a bug list, you are doing something drastically wrong.